<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admission Tracker Pro</title>
  
  <!-- Clerk Authentication -->
  <script
    async
    crossorigin="anonymous"
    data-clerk-publishable-key="pk_test_ZmFzdC1vY3RvcHVzLTE3LmNsZXJrLmFjY291bnRzLmRldiQ"
    src="https://fast-octopus-17.clerk.accounts.dev/npm/@clerk/clerk-js@5/dist/clerk.browser.js"
    type="text/javascript">
  </script>

  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class'
    }
  </script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@300;400;500;600;700&display=swap');

    body {
      font-family: "Hind Siliguri", sans-serif;
    }

    .clerk-user-button {
      background: none !important;
      box-shadow: none !important;
      padding: 0 !important;
    }

    .clerk-user-button:hover {
      background: none !important;
    }
  </style>
  
  <!-- jsPDF for PDF export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body class="bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-gray-100 transition-colors duration-500">
  <!-- Clerk Auth Modals -->
  <div id="auth-modals"></div>

  <!-- Loading overlay -->
  <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl flex items-center space-x-4">
      <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-500"></div>
      <span class="text-lg font-medium">Processing...</span>
    </div>
  </div>

  <header
    class="backdrop-blur-lg bg-white/80 dark:bg-gray-900/80 text-gray-900 dark:text-white shadow-lg sticky top-0 z-50 border-b border-gray-200 dark:border-gray-700">
    <div class="container mx-auto px-4 py-3 flex flex-col md:flex-row items-center justify-between gap-4">

      <!-- Branding Section -->
      <div class="flex flex-col items-center md:items-start gap-2 w-full md:w-auto">
        <!-- Logo and Title -->
        <div class="flex items-center gap-3">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-9 w-9 text-yellow-500 dark:text-yellow-400 drop-shadow"
            fill="currentColor" viewBox="0 0 24 24">
            <path d="M12 2L1 7l11 5 9-4.09v6.18L12 22 3 13.18V7L12 2z" />
          </svg>
          <h1
            class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-600 via-purple-500 to-pink-500 dark:from-yellow-300 dark:via-orange-400 dark:to-red-500 drop-shadow">
            Admission Tracker Pro
          </h1>
        </div>

        <!-- Developer Credit - Modern Compact Badge -->
        <a href="https://wa.me/+8801840643946" target="_blank"
          class="group relative inline-flex items-center px-3 py-1.5 rounded-full bg-gradient-to-r from-sky-500 to-indigo-600 dark:from-yellow-400 dark:to-orange-500 text-white text-xs font-medium shadow-sm hover:shadow-md transition-all duration-200 overflow-hidden">
          <span class="relative z-10 flex items-center gap-1.5">
            <span class="text-xs">üë®‚Äçüíª</span>
            <span>Mustafa Rahman</span>
          </span>
        </a>
      </div>

      <!-- Warning Notice -->
      <div
        class="w-full md:max-w-md lg:max-w-xl xl:max-w-2xl bg-white dark:bg-gray-800 border-2 border-red-500 dark:border-red-400 rounded-lg p-3 shadow-lg animate-pulse">
        <div class="flex items-center justify-center gap-2 text-red-700 dark:text-red-300 font-bold text-sm sm:text-base">
          <span class="text-center">‚ö†Ô∏è ‡¶è‡¶ü‡¶ø ‡¶∞‡¶ø‡ßü‡ßá‡¶≤ ‡¶∏‡ßá‡¶®‡ßç‡¶∏‡¶∏‡¶ø‡¶ü‡¶ø‡¶≠ ‡¶°‡¶æ‡¶ü‡¶æ‡¶¨‡ßá‡¶ú ‡¶≠‡¶ø‡¶§‡ßç‡¶§‡¶ø‡¶ï ‡¶∏‡¶´‡¶ü‡¶ì‡ßü‡ßç‡¶Ø‡¶æ‡¶∞ ‚Äî ‡¶§‡¶•‡ßç‡¶Ø ‡¶°‡¶ø‡¶≤‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶•‡ßá‡¶ï‡ßá ‡¶¨‡¶ø‡¶∞‡¶§ ‡¶•‡¶æ‡¶ï‡ßÅ‡¶®</span>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="flex flex-row items-center justify-center gap-3 w-full md:w-auto">
        <!-- Auth Buttons -->
        <div id="authButtons" class="flex items-center gap-2">
          <button id="signInButton" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-md transition hidden">
            Sign In
          </button>
          <button id="signUpButton" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-md transition hidden">
            Sign Up
          </button>
          <div id="userButton" class="hidden"></div>
        </div>

        <!-- Add Student Button (shown only when authenticated) -->
        <button id="openStudentPanel"
          class="relative overflow-hidden hidden items-center gap-2 bg-gradient-to-br from-blue-500 to-blue-600 dark:from-blue-600 dark:to-blue-700 text-white px-5 py-2.5 rounded-lg shadow-lg hover:shadow-xl transition-all duration-300 hover:-translate-y-0.5 active:translate-y-0 active:scale-[0.98] font-medium">
          <span class="relative z-10 flex items-center gap-2">
            <i class="fas fa-plus text-sm transition-transform hover:scale-110"></i>
            <span class="text-sm tracking-wide">Add Student</span>
          </span>
        </button>

        <!-- Dark Mode Toggle -->
        <div id="darkModeToggle"
          class="w-16 h-9 flex items-center bg-gray-200 dark:bg-gray-600 rounded-full p-1 cursor-pointer transition-all duration-300 shadow-inner">
          <div id="toggleThumb"
            class="bg-white dark:bg-yellow-400 w-7 h-7 rounded-full shadow-md transform transition-all duration-300 flex items-center justify-center">
            <span id="toggleIcon" class="text-sm">üåô</span>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="container mx-auto px-4 py-6 space-y-6">
    <!-- Authentication Required Message -->
    <div id="authRequiredMessage" class="bg-white dark:bg-gray-800 rounded-xl shadow p-6 border border-gray-200 dark:border-gray-700 text-center py-10 hidden">
      <i class="fas fa-lock text-4xl text-gray-400 mb-4"></i>
      <h2 class="text-xl font-semibold mb-2">Authentication Required</h2>
      <p class="text-gray-500 dark:text-gray-400 mb-4">Please sign in to access the Admission Tracker</p>
      <button id="signInButtonMain" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-md transition">
        Sign In
      </button>
    </div>

    <!-- Dashboard Content (shown only when authenticated) -->
    <div id="dashboardContent" class="hidden">
      <!-- All your existing dashboard content goes here -->
      <!-- ... (keep all your existing sections) ... -->
    </div>
  </main>

  <!-- Rest of your HTML remains the same -->
  <!-- ... (keep all your existing modals and footer) ... -->

  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      // Initialize Clerk
      await initializeClerk();
      
      // Rest of your existing JavaScript
      // ... (keep all your existing code) ...
    });

    // ================ CLERK AUTHENTICATION ================
    async function initializeClerk() {
      try {
        // Load Clerk
        const Clerk = await window.Clerk;
        
        if (!Clerk) {
          throw new Error("Clerk failed to load");
        }

        // Initialize Clerk
        await Clerk.load({
          publishableKey: 'pk_test_ZmFzdC1vY3RvcHVzLTE3LmNsZXJrLmFjY291bnRzLmRldiQ'
        });

        // Get Clerk instances
        const clerk = Clerk;
        const { user } = Clerk;

        // UI Elements
        const signInButton = document.getElementById('signInButton');
        const signUpButton = document.getElementById('signUpButton');
        const signInButtonMain = document.getElementById('signInButtonMain');
        const userButton = document.getElementById('userButton');
        const authRequiredMessage = document.getElementById('authRequiredMessage');
        const dashboardContent = document.getElementById('dashboardContent');
        const openStudentPanel = document.getElementById('openStudentPanel');

        // Update UI based on auth state
        Clerk.addListener(({ user }) => {
          if (user) {
            // User is signed in
            signInButton.classList.add('hidden');
            signUpButton.classList.add('hidden');
            signInButtonMain.classList.add('hidden');
            userButton.classList.remove('hidden');
            authRequiredMessage.classList.add('hidden');
            dashboardContent.classList.remove('hidden');
            openStudentPanel.classList.remove('hidden');

            // Mount user button
            Clerk.mountUserButton(userButton, {
              appearance: {
                elements: {
                  userButton: 'clerk-user-button',
                  userButtonAvatarBox: 'w-8 h-8',
                  userButtonTrigger: 'focus:shadow-none'
                }
              }
            });

            // Set user role in localStorage (you would get this from your backend)
            localStorage.setItem('userRole', 'admin'); // or 'counselor', 'viewer'
          } else {
            // User is signed out
            signInButton.classList.remove('hidden');
            signUpButton.classList.remove('hidden');
            userButton.classList.add('hidden');
            authRequiredMessage.classList.remove('hidden');
            dashboardContent.classList.add('hidden');
            openStudentPanel.classList.add('hidden');
          }
        });

        // Set up sign in/out buttons
        signInButton?.addEventListener('click', () => Clerk.openSignIn());
        signInButtonMain?.addEventListener('click', () => Clerk.openSignIn());
        signUpButton?.addEventListener('click', () => Clerk.openSignUp());

        // Initialize Clerk auth modals
        Clerk.mountSignIn(document.getElementById('auth-modals'), {
          appearance: {
            variables: {
              colorPrimary: '#3b82f6',
              colorText: '#1f2937',
              colorTextSecondary: '#6b7280',
              colorBackground: '#ffffff',
              colorInputBackground: '#ffffff',
              colorInputText: '#1f2937'
            },
            elements: {
              card: 'shadow-lg rounded-xl',
              headerTitle: 'text-xl font-bold',
              socialButtons: 'gap-2',
              socialButton: 'border border-gray-200 hover:bg-gray-50',
              formButtonPrimary: 'bg-blue-600 hover:bg-blue-700',
              footerActionLink: 'text-blue-600 hover:text-blue-800'
            }
          }
        });

        // Add Google as OAuth provider
        Clerk.addGoogleProvider();

      } catch (error) {
        console.error('Clerk initialization error:', error);
        // Fallback to basic auth if Clerk fails
        document.getElementById('authRequiredMessage').classList.remove('hidden');
        document.getElementById('signInButtonMain').addEventListener('click', () => {
          alert('Authentication service is currently unavailable. Please try again later.');
        });
      }
    }

    // Role-based access control
    function checkPermission(action) {
      const userRole = localStorage.getItem('userRole') || 'viewer';
      const userRoles = {
        admin: ['view', 'edit', 'delete', 'export', 'import', 'settings'],
        counselor: ['view', 'edit', 'add'],
        viewer: ['view']
      };
      return userRoles[userRole]?.includes(action);
    }

    // Apply permissions to UI elements
    function applyPermissions() {
      if (!checkPermission('add')) {
        document.getElementById('openStudentPanel').classList.add('hidden');
      }
      if (!checkPermission('delete')) {
        document.querySelectorAll('.delete-btn').forEach(btn => btn.classList.add('hidden'));
      }
      if (!checkPermission('export')) {
        document.getElementById('exportCSV').classList.add('hidden');
        document.getElementById('exportPDF').classList.add('hidden');
      }
    }

    // Initialize the rest of your application
    async function initializeApp() {
      // Your existing initialization code
      // ... (keep all your existing initialization) ...

      // Apply permissions after auth
      applyPermissions();
    }
  </script>
</body>
</html>