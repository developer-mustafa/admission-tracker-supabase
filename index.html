<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admission Tracker</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
    }
  </script>
  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-gray-100 transition-colors duration-500">
  <!-- Loading overlay -->
  <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl flex items-center space-x-4">
      <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-500"></div>
      <span class="text-lg font-medium">Processing...</span>
    </div>
  </div>

  <!-- Header Section -->
  <header class="backdrop-blur-md bg-white/30 dark:bg-gray-900/30 text-gray-900 dark:text-white py-6 shadow-xl">
    <div class="container mx-auto px-4 flex flex-col md:flex-row items-center justify-between gap-4">
      <!-- Logo and Title -->
      <div class="flex items-center gap-4">
        <!-- Graduation Cap Icon -->
        <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-yellow-400 dark:text-yellow-300" fill="currentColor" viewBox="0 0 24 24">
          <path d="M12 2L1 7l11 5 9-4.09v6.18L12 22 3 13.18V7L12 2z" />
        </svg>
        <h1 class="text-3xl font-bold tracking-wide bg-clip-text text-transparent bg-gradient-to-r from-blue-700 via-purple-600 to-pink-500 dark:from-yellow-300 dark:via-orange-400 dark:to-red-500">
          Admission Tracker
        </h1>
      </div>
      <!-- Capsule Toggle Switch -->
      <div id="darkModeToggle" class="w-16 h-8 flex items-center bg-gray-300 dark:bg-gray-700 rounded-full p-1 cursor-pointer transition-all duration-300">
        <div id="toggleThumb" class="bg-white dark:bg-yellow-400 w-6 h-6 rounded-full shadow-md transform transition-all duration-300 flex items-center justify-center">
          <span id="toggleIcon" class="text-sm">ðŸŒ™</span>
        </div>
      </div>
    </div>
    <!-- Developer Credit -->
    <div class="text-center mt-4 text-sm text-gray-700 dark:text-gray-300">
      Developed by 
      <a href="https://wa.me/8801840643946" target="_blank" class="font-semibold text-blue-700 dark:text-yellow-400 hover:underline">
        Mustafa Rahman
      </a>
    </div>
  </header>

  <main class="container mx-auto px-4 py-6 space-y-6">
    <!-- Summary Dashboard -->
    <section class="grid grid-cols-1 md:grid-cols-4 gap-6">
      <div class="bg-white dark:bg-gray-800 rounded-xl shadow p-6 flex items-center">
        <div class="p-3 bg-blue-100 dark:bg-blue-900 rounded-full mr-4">
          <i class="fas fa-users text-blue-600 dark:text-blue-300 text-xl"></i>
        </div>
        <div>
          <h3 class="text-gray-500 dark:text-gray-400 text-sm font-medium">Total Students</h3>
          <p id="totalStudents" class="text-2xl font-bold">0</p>
        </div>
      </div>
      <div class="bg-white dark:bg-gray-800 rounded-xl shadow p-6 flex items-center">
        <div class="p-3 bg-green-100 dark:bg-green-900 rounded-full mr-4">
          <i class="fas fa-check-circle text-green-600 dark:text-green-300 text-xl"></i>
        </div>
        <div>
          <h3 class="text-gray-500 dark:text-gray-400 text-sm font-medium">Paid</h3>
          <p id="paidStudents" class="text-2xl font-bold">0</p>
        </div>
      </div>
      <div class="bg-white dark:bg-gray-800 rounded-xl shadow p-6 flex items-center">
        <div class="p-3 bg-yellow-100 dark:bg-yellow-900 rounded-full mr-4">
          <i class="fas fa-exclamation-circle text-yellow-600 dark:text-yellow-300 text-xl"></i>
        </div>
        <div>
          <h3 class="text-gray-500 dark:text-gray-400 text-sm font-medium">Follow-Up Needed</h3>
          <p id="followupStudents" class="text-2xl font-bold">0</p>
        </div>
      </div>
      <div class="bg-white dark:bg-gray-800 rounded-xl shadow p-6 flex items-center">
        <div class="p-3 bg-red-100 dark:bg-red-900 rounded-full mr-4">
          <i class="fas fa-ban text-red-600 dark:text-red-300 text-xl"></i>
        </div>
        <div>
          <h3 class="text-gray-500 dark:text-gray-400 text-sm font-medium">Not Interested</h3>
          <p id="noneStudents" class="text-2xl font-bold">0</p>
        </div>
      </div>
    </section>

    <!-- Search & Filters Section -->
    <section class="bg-white dark:bg-gray-800 rounded-xl shadow p-6">
      <h2 class="text-2xl font-semibold mb-4">Search &amp; Filters</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <input id="searchData" type="text" placeholder="Search by name, phone, or group"
          class="p-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400 dark:bg-gray-700 dark:border-gray-600" />
        <select id="searchStatus"
          class="p-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400 dark:bg-gray-700 dark:border-gray-600">
          <option value="">All Statuses</option>
          <option value="None">None (Not Interested)</option>  
          <option value="not_Checked">Not Checked</option>
          <option value="Called">Called</option>
          <option value="Follow-Up Needed">Follow-Up Needed</option>
          <option value="Agreed">Agreed</option>
          <option value="Confirmed">Confirmed</option>
          <option value="Paid">Paid</option>
        </select>
        <button id="clearFilters"
          class="p-3 bg-gray-200 dark:bg-gray-700 rounded-md hover:bg-gray-300 dark:hover:bg-gray-600 transition duration-300 focus:outline-none focus:ring">
          Clear Filters
        </button>
      </div>
    </section>

    <!-- Student Management Section -->
    <section class="bg-white dark:bg-gray-800 rounded-xl shadow p-6">
      <h2 class="text-2xl font-semibold mb-4">Add Student Panel</h2>
      <form id="studentForm" class="grid grid-cols-1 md:grid-cols-6 gap-4 mb-6">
        <input type="text" id="name" placeholder="Name"
          class="p-3 border rounded-md col-span-2 focus:outline-none focus:ring-2 focus:ring-blue-400 dark:bg-gray-700 dark:border-gray-600"
          required />
        <input type="text" id="phone" placeholder="Phone"
          class="p-3 border rounded-md col-span-2 focus:outline-none focus:ring-2 focus:ring-blue-400 dark:bg-gray-700 dark:border-gray-600"
          required />
        <input type="text" id="group" placeholder="Group (Science, Commerce, Arts)"
          class="p-3 border rounded-md col-span-1 focus:outline-none focus:ring-2 focus:ring-blue-400 dark:bg-gray-700 dark:border-gray-600"
          required />
        <input type="date" id="date"
          class="p-3 border rounded-md col-span-1 focus:outline-none focus:ring-2 focus:ring-blue-400 dark:bg-gray-700 dark:border-gray-600"
          required />
        <select id="status"
          class="p-3 border rounded-md col-span-2 focus:outline-none focus:ring-2 focus:ring-blue-400 dark:bg-gray-700 dark:border-gray-600">
          <option value="None">None (Not Interested)</option>
          <option value="not_Checked">Not Checked</option>
          <option value="Called">Called</option>
          <option value="Follow-Up Needed">Follow-Up Needed</option>
          <option value="Agreed">Agreed</option>
          <option value="Confirmed">Confirmed</option>
          <option value="Paid">Paid</option>
        </select>
        <div class="col-span-2">
          <button type="submit"
            class="w-full p-3 bg-blue-600 text-white rounded-md hover:bg-blue-500 transition duration-300 focus:outline-none focus:ring">
            Add Student
          </button>
        </div>
      </form>
      <!-- Student List Grid Layout -->
      <div id="studentList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <!-- Student cards will be injected here -->
      </div>
    </section>

    <!-- Backup, Export, Restore & Import Section -->
    <section class="bg-white dark:bg-gray-800 rounded-xl shadow p-6">
      <h2 class="text-2xl font-semibold mb-4">Backup, Export &amp; Import</h2>
      <div class="flex flex-wrap gap-4">
        <button id="exportCSV"
          class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-500 transition duration-300 focus:outline-none focus:ring">
          Export CSV
        </button>
        <button id="backupJSON"
          class="px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-500 transition duration-300 focus:outline-none focus:ring">
          Backup JSON
        </button>
        <label for="restoreJSON"
          class="px-4 py-2 bg-yellow-600 text-white rounded-md hover:bg-yellow-500 transition duration-300 cursor-pointer focus:outline-none focus:ring">
          Restore JSON
        </label>
        <input type="file" id="restoreJSON" accept="application/json" class="hidden" />
        <label for="importCSV"
          class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-500 transition duration-300 cursor-pointer focus:outline-none focus:ring">
          Import CSV
        </label>
        <input type="file" id="importCSV" accept=".csv, text/csv" class="hidden" />
      </div>
    </section>

    <!-- Analytics Dashboard Section -->
    <section class="bg-white dark:bg-gray-800 rounded-xl shadow p-6">
      <h2 class="text-2xl font-semibold mb-4">Analytics Dashboard</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="relative h-64">
          <canvas id="statusChart"></canvas>
        </div>
        <div class="relative h-64">
          <canvas id="groupChart"></canvas>
        </div>
      </div>
      <div class="mt-6 relative h-64">
        <canvas id="deptChart"></canvas>
      </div>
    </section>
  </main>

  <!-- Modal for Editing Student Details -->
  <div id="studentModal" class="fixed inset-0 bg-gray-800 bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-white dark:bg-gray-700 rounded-xl p-6 w-11/12 md:w-1/2 shadow-lg">
      <h2 id="modalTitle" class="text-2xl font-bold mb-4"></h2>
      <form id="editStudentForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <input type="text" id="editName" placeholder="Name"
          class="p-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400 dark:bg-gray-700 dark:border-gray-600" required />
        <input type="text" id="editPhone" placeholder="Phone"
          class="p-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400 dark:bg-gray-700 dark:border-gray-600" required />
        <input type="text" id="editGroup" placeholder="Group (Science, Commerce, Arts)"
          class="p-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400 dark:bg-gray-700 dark:border-gray-600" required />
        <input type="date" id="editDate"
          class="p-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400 dark:bg-gray-700 dark:border-gray-600" required />
        <select id="editStatus"
          class="p-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400 dark:bg-gray-700 dark:border-gray-600">
          <option value="None">None (Not Interested)</option>
          <option value="not_Checked">Not Checked</option>
          <option value="Called">Called</option>
          <option value="Follow-Up Needed">Follow-Up Needed</option>
          <option value="Agreed">Agreed</option>
          <option value="Confirmed">Confirmed</option>
          <option value="Paid">Paid</option>
        </select>
        <div class="md:col-span-2 flex justify-end gap-4">
          <button type="button" id="cancelEdit"
            class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-500 transition duration-300 focus:outline-none focus:ring">
            Cancel
          </button>
          <button type="submit"
            class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-500 transition duration-300 focus:outline-none focus:ring">
            Save
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div id="deleteModal" class="fixed inset-0 bg-gray-800 bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-white dark:bg-gray-700 rounded-xl p-6 w-11/12 md:w-1/3 shadow-lg">
      <h2 class="text-2xl font-bold mb-4">Confirm Deletion</h2>
      <p class="mb-6">Are you sure you want to delete this student record? This action cannot be undone.</p>
      <div class="flex justify-end gap-4">
        <button id="cancelDelete"
          class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-500 transition duration-300 focus:outline-none focus:ring">
          Cancel
        </button>
        <button id="confirmDelete"
          class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-500 transition duration-300 focus:outline-none focus:ring">
          Delete
        </button>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
  // Initialize Supabase client
  const supabaseUrl = 'https://erihbeinkymnymncnawm.supabase.co';
  const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVyaWhiZWlua3ltbnltbmNuYXdtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY3NzEwMzUsImV4cCI6MjA2MjM0NzAzNX0.xhE0_RbBQ9qQcYHa5sv-S9-cUolJruo0Km3oud-GtOM';
  const supabaseMain = supabase.createClient(supabaseUrl, supabaseKey);

  // DOM references
  const studentForm = document.getElementById("studentForm");
  const studentList = document.getElementById("studentList");
  const darkModeToggle = document.getElementById("darkModeToggle");
  const toggleThumb = document.getElementById("toggleThumb");
  const toggleIcon = document.getElementById("toggleIcon");
  const exportCSVButton = document.getElementById("exportCSV");
  const backupJSONButton = document.getElementById("backupJSON");
  const restoreJSONInput = document.getElementById("restoreJSON");
  const importCSVInput = document.getElementById("importCSV");
  const loadingOverlay = document.getElementById("loadingOverlay");
  const clearFiltersButton = document.getElementById("clearFilters");

  // Dashboard elements
  const totalStudentsElement = document.getElementById("totalStudents");
  const paidStudentsElement = document.getElementById("paidStudents");
  const followupStudentsElement = document.getElementById("followupStudents");
  const noneStudentsElement = document.getElementById("noneStudents");

  // Search and filter elements
  const searchData = document.getElementById("searchData");
  const searchStatus = document.getElementById("searchStatus");

  // Modal elements
  const studentModal = document.getElementById("studentModal");
  const modalTitle = document.getElementById("modalTitle");
  const editStudentForm = document.getElementById("editStudentForm");
  const editName = document.getElementById("editName");
  const editPhone = document.getElementById("editPhone");
  const editGroup = document.getElementById("editGroup");
  const editDate = document.getElementById("editDate");
  const editStatus = document.getElementById("editStatus");
  const cancelEdit = document.getElementById("cancelEdit");

  // Delete modal elements
  const deleteModal = document.getElementById("deleteModal");
  const cancelDelete = document.getElementById("cancelDelete");
  const confirmDelete = document.getElementById("confirmDelete");

  // Status configuration
  const statusConfig = {
    "not_Checked": {
      icon: `<i class="fas fa-circle-notch text-gray-500 mr-1"></i>`,
      classes: "bg-gray-200 border border-gray-400 text-gray-700 dark:bg-gray-700 dark:border-gray-500 dark:text-gray-300"
    },
    "None": {
      icon: `<i class="fas fa-ban text-red-500 mr-1"></i>`,
      classes: "bg-gray-800 border border-red-500 text-red-100 dark:bg-gray-900 dark:border-red-600 dark:text-red-200"
    },
    "Called": {
      icon: `<i class="fas fa-phone-alt text-blue-600 mr-1"></i>`,
      classes: "bg-blue-100 border border-blue-500 text-blue-800 dark:bg-blue-900 dark:border-blue-700 dark:text-blue-200"
    },
    "Follow-Up Needed": {
      icon: `<i class="fas fa-exclamation-circle text-red-600 mr-1"></i>`,
      classes: "bg-red-100 border border-red-500 text-red-800 dark:bg-red-900 dark:border-red-700 dark:text-red-200"
    },
    "Agreed": {
      icon: `<i class="fas fa-check-circle text-green-600 mr-1"></i>`,
      classes: "bg-green-100 border border-green-500 text-green-800 dark:bg-green-900 dark:border-green-700 dark:text-green-200"
    },
    "Confirmed": {
      icon: `<i class="fas fa-check-double text-yellow-600 mr-1"></i>`,
      classes: "bg-yellow-100 border border-yellow-500 text-yellow-800 dark:bg-yellow-900 dark:border-yellow-700 dark:text-yellow-200"
    },
    "Paid": {
      icon: `<i class="fas fa-check-circle text-green-100 mr-1"></i>`,
      classes: "bg-green-800 border border-green-600 text-green-50 dark:bg-green-900 dark:border-green-700 dark:text-green-100"
    }
  };

  // Initialize students array
  let students = [];
  let editingId = null;
  let deletingId = null;

  // Chart variables
  let statusChart, groupChart, deptChart;
  const ctxStatus = document.getElementById("statusChart").getContext("2d");
  const ctxGroup = document.getElementById("groupChart").getContext("2d");
  const ctxDept = document.getElementById("deptChart").getContext("2d");

  // Show loading overlay
  const showLoading = () => {
    loadingOverlay.classList.remove("hidden");
  };

  // Hide loading overlay
  const hideLoading = () => {
    loadingOverlay.classList.add("hidden");
  };

  // Show toast notification
  const showToast = (message, type = 'info') => {
    const toast = document.createElement('div');
    const colors = {
      success: 'bg-green-500',
      error: 'bg-red-500',
      warning: 'bg-yellow-500',
      info: 'bg-blue-500'
    };
    
    toast.className = `fixed bottom-4 right-4 ${colors[type]} text-white px-4 py-2 rounded-md shadow-lg transition-opacity duration-300 opacity-0`;
    toast.textContent = message;
    document.body.appendChild(toast);
    
    // Animate in
    setTimeout(() => toast.classList.replace('opacity-0', 'opacity-100'), 10);
    
    // Auto-dismiss after 3 seconds
    setTimeout(() => {
      toast.classList.replace('opacity-100', 'opacity-0');
      setTimeout(() => toast.remove(), 300);
    }, 3000);
  };

  // Fetch students from Supabase
  const fetchStudents = async () => {
    showLoading();
    try {
      const { data, error } = await supabaseMain
        .from('students')
        .select('*')
        .order('date', { ascending: false });

      if (error) throw error;

      students = data || [];
      saveStudentsToLocal();
      renderStudents();
      updateDashboard();
      updateCharts();
    } catch (error) {
      console.error('Error fetching students:', error);
      // Fallback to local storage if Supabase fails
      students = JSON.parse(localStorage.getItem("students")) || [];
      renderStudents();
      updateDashboard();
      updateCharts();
      showToast('Using local data (network issue)', 'warning');
    } finally {
      hideLoading();
    }
  };

  // Save students to local storage as backup
  const saveStudentsToLocal = () => {
    localStorage.setItem("students", JSON.stringify(students));
  };

  // Add student to Supabase
  const addStudent = async (student) => {
    showLoading();
    try {
      const { data, error } = await supabaseMain
        .from('students')
        .insert([student])
        .select();

      if (error) throw error;

      if (data && data.length > 0) {
        students.unshift(data[0]);
        saveStudentsToLocal();
        renderStudents();
        updateDashboard();
        updateCharts();
        showToast('Student added successfully', 'success');
      }
    } catch (error) {
      console.error('Error adding student:', error);
      // Fallback to local storage
      student.id = Date.now().toString();
      students.unshift(student);
      saveStudentsToLocal();
      renderStudents();
      updateDashboard();
      updateCharts();
      showToast('Added locally (network issue)', 'warning');
    } finally {
      hideLoading();
    }
  };

  // Update student in Supabase - FIXED VERSION
  const updateStudent = async (id, updates) => {
    showLoading();
    try {
      const { data, error } = await supabaseMain
        .from('students')
        .update(updates)
        .eq('id', id)
        .select();

      if (error) {
        console.error('Supabase update error:', error);
        throw error;
      }

      if (data && data.length > 0) {
        const index = students.findIndex(s => s.id === id);
        if (index !== -1) {
          // Create a new array to trigger reactivity
          const updatedStudents = [...students];
          updatedStudents[index] = data[0];
          students = updatedStudents;
          
          saveStudentsToLocal();
          renderStudents();
          updateDashboard();
          updateCharts();
          
          showToast('Student updated successfully', 'success');
        }
      }
    } catch (error) {
      console.error('Error updating student:', error);
      // Fallback to local storage
      const index = students.findIndex(s => s.id === id);
      if (index !== -1) {
        const updatedStudents = [...students];
        updatedStudents[index] = { 
          ...updatedStudents[index], 
          ...updates,
          id: updatedStudents[index].id 
        };
        students = updatedStudents;
        
        saveStudentsToLocal();
        renderStudents();
        updateDashboard();
        updateCharts();
        
        showToast('Updated locally (network issue)', 'warning');
      } else {
        showToast('Failed to update student', 'error');
      }
    } finally {
      hideLoading();
    }
  };

  // Delete student from Supabase
  const deleteStudent = async (id) => {
    showLoading();
    try {
      const { error } = await supabaseMain
        .from('students')
        .delete()
        .eq('id', id);

      if (error) throw error;

      students = students.filter(student => student.id !== id);
      saveStudentsToLocal();
      renderStudents();
      updateDashboard();
      updateCharts();
      showToast('Student deleted successfully', 'success');
    } catch (error) {
      console.error('Error deleting student:', error);
      // Fallback to local storage
      students = students.filter(student => student.id !== id);
      saveStudentsToLocal();
      renderStudents();
      updateDashboard();
      updateCharts();
      showToast('Deleted locally (network issue)', 'warning');
    } finally {
      hideLoading();
    }
  };

  // Update dashboard summary
  const updateDashboard = () => {
    const total = students.length;
    const paid = students.filter(s => s.status === 'Paid').length;
    const followup = students.filter(s => s.status === 'Follow-Up Needed').length;
    const none = students.filter(s => s.status === 'None').length;

    totalStudentsElement.textContent = total;
    paidStudentsElement.textContent = paid;
    followupStudentsElement.textContent = followup;
    noneStudentsElement.textContent = none;
  };

  // Debounce helper for filtering
  const debounce = (func, delay) => {
    let debounceTimer;
    return function (...args) {
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(() => func.apply(this, args), delay);
    }
  };

  // Render the student grid (as responsive cards)
  const renderStudents = () => {
    const searchTerm = searchData.value.toLowerCase();
    const filterStatus = searchStatus.value;

    studentList.innerHTML = "";

    // Show loading state
    if (students.length === 0) {
      studentList.innerHTML = `
        <div class="col-span-full text-center py-10">
          <i class="fas fa-user-graduate text-4xl text-gray-400 mb-4"></i>
          <p class="text-gray-500 dark:text-gray-400">No students found. Add your first student above.</p>
        </div>
      `;
      return;
    }

    const filteredStudents = students.filter(student => {
      // Apply status filter if selected
      if (filterStatus && student.status !== filterStatus) return false;

      // Apply search term if provided
      if (searchTerm) {
        return (
          student.name.toLowerCase().includes(searchTerm) ||
          student.phone.toLowerCase().includes(searchTerm) ||
          student.group.toLowerCase().includes(searchTerm)
        );
      }

      return true;
    });

    if (filteredStudents.length === 0) {
      studentList.innerHTML = `
        <div class="col-span-full text-center py-10">
          <i class="fas fa-search text-4xl text-gray-400 mb-4"></i>
          <p class="text-gray-500 dark:text-gray-400">No students match your search criteria.</p>
        </div>
      `;
      return;
    }

    filteredStudents.forEach((student) => {
      const config = statusConfig[student.status] || {
        icon: '<i class="fas fa-question-circle text-gray-600 mr-1"></i>',
        classes: 'bg-gray-100 border border-gray-300 text-gray-900 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200'
      };

      const card = document.createElement("div");
      card.className = `p-6 border-l-4 ${config.classes} shadow hover:shadow-lg transition-all rounded-xl flex flex-col`;
      card.innerHTML = `
        <div class="flex-grow">
          <div class="flex justify-between items-center mb-3">
            <h3 class="text-xl font-bold">${student.name}</h3>
            <div class="flex items-center">
              ${config.icon}
              <span class="ml-1 text-sm font-medium">${student.status}</span>
            </div>
          </div>
          <div class="mb-4 text-sm">
            <p class="mb-1"><span class="font-medium">Phone:</span> ${student.phone}</p>
            <p class="mb-1"><span class="font-medium">Group:</span> ${student.group}</p>
            <p><span class="font-medium">Date:</span> ${student.date}</p>
          </div>
        </div>
        <div class="flex space-x-2 mt-auto">
          <a href="tel:${student.phone}" class="px-3 py-1 bg-green-600 text-white rounded hover:bg-green-500 transition duration-300 focus:outline-none focus:ring flex items-center justify-center">
            <i class="fas fa-phone mr-2"></i> Call
          </a>
          <button onclick="openEditModal('${student.id}')" class="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-500 transition duration-300 focus:outline-none focus:ring flex items-center justify-center">
            <i class="fas fa-edit mr-2"></i> Edit
          </button>
          <button onclick="showDeleteModal('${student.id}')" class="px-3 py-1 bg-red-600 text-white rounded hover:bg-red-500 transition duration-300 focus:outline-none focus:ring flex items-center justify-center">
            <i class="fas fa-trash mr-2"></i> Delete
          </button>
        </div>
      `;
      studentList.appendChild(card);
    });
  };

  // Add new student record
  studentForm.addEventListener("submit", (e) => {
    e.preventDefault();
    const name = document.getElementById("name").value.trim();
    const phone = document.getElementById("phone").value.trim();
    const group = document.getElementById("group").value.trim();
    const date = document.getElementById("date").value;
    const status = document.getElementById("status").value;

    if (name && phone && group && date) {
      const newStudent = { name, phone, group, date, status };
      addStudent(newStudent);
      studentForm.reset();
    } else {
      showToast('Please fill all required fields', 'error');
    }
  });

  // Open edit modal
  window.openEditModal = (id) => {
    const student = students.find(s => s.id === id);
    if (student) {
      editingId = id;
      modalTitle.textContent = `Edit: ${student.name}`;
      editName.value = student.name;
      editPhone.value = student.phone;
      editGroup.value = student.group;
      editDate.value = student.date;
      editStatus.value = student.status;
      studentModal.classList.remove("hidden");
    }
  };

  // Close modal
  const closeModal = () => {
    studentModal.classList.add("hidden");
    editingId = null;
  };

  // Save edits - FIXED VERSION
  editStudentForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    if (editingId !== null) {
      const updates = {
        name: editName.value.trim(),
        phone: editPhone.value.trim(),
        group: editGroup.value.trim(),
        date: editDate.value,
        status: editStatus.value,
        id: editingId
      };
      
      if (!updates.name || !updates.phone || !updates.group || !updates.date) {
        showToast('Please fill all required fields', 'error');
        return;
      }
      
      await updateStudent(editingId, updates);
      closeModal();
    }
  });

  cancelEdit.addEventListener("click", closeModal);

  // Show delete confirmation modal
  window.showDeleteModal = (id) => {
    deletingId = id;
    deleteModal.classList.remove("hidden");
  };

  // Confirm deletion
  confirmDelete.addEventListener("click", () => {
    deleteStudent(deletingId);
    deleteModal.classList.add("hidden");
    deletingId = null;
  });

  // Cancel deletion
  cancelDelete.addEventListener("click", () => {
    deleteModal.classList.add("hidden");
    deletingId = null;
  });

  // Clear all filters
  clearFiltersButton.addEventListener("click", () => {
    searchData.value = "";
    searchStatus.value = "";
    renderStudents();
  });

  // Apply debounced filtering
  const handleSearch = debounce(renderStudents, 300);
  searchData.addEventListener("input", handleSearch);
  searchStatus.addEventListener("change", handleSearch);

  // CSV Export
  exportCSVButton.addEventListener("click", () => {
    showLoading();
    setTimeout(() => {
      let csvContent = "data:text/csv;charset=utf-8,Name,Phone,Group,Date,Status\n";
      students.forEach(student => {
        const row = [student.name, student.phone, student.group, student.date, student.status].join(",");
        csvContent += row + "\n";
      });
      const encodedUri = encodeURI(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", "students.csv");
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      hideLoading();
      showToast('CSV exported successfully', 'success');
    }, 500);
  });

  // Backup JSON Export
  backupJSONButton.addEventListener("click", () => {
    showLoading();
    setTimeout(() => {
      const dataStr = JSON.stringify(students, null, 2);
      const blob = new Blob([dataStr], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "students_backup.json";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      hideLoading();
      showToast('JSON backup downloaded', 'success');
    }, 500);
  });

  // Restore JSON Import
  restoreJSONInput.addEventListener("change", (e) => {
    const file = e.target.files[0];
    if (!file) return;

    showLoading();
    const reader = new FileReader();
    reader.onload = (event) => {
      setTimeout(() => {
        try {
          const data = JSON.parse(event.target.result);
          if (Array.isArray(data)) {
            // Clear existing data first
            students = [];
            saveStudentsToLocal();

            // Add each student to Supabase
            data.forEach(student => {
              addStudent(student);
            });
            showToast('Data restored successfully', 'success');
          } else {
            showToast('Invalid file format', 'error');
          }
        } catch (err) {
          showToast('Error parsing JSON', 'error');
        }
        hideLoading();
      }, 500);
    };
    reader.readAsText(file);
  });

  // CSV Import
  importCSVInput.addEventListener("change", (e) => {
    const file = e.target.files[0];
    if (!file) return;

    showLoading();
    const reader = new FileReader();
    reader.onload = (event) => {
      setTimeout(() => {
        try {
          const text = event.target.result;
          const lines = text.split("\n").filter(line => line.trim() !== "");
          let startIndex = 0;
          if (lines[0].toLowerCase().includes("name")) startIndex = 1;

          const newStudents = [];
          for (let i = startIndex; i < lines.length; i++) {
            const cols = lines[i].split(",");
            if (cols.length < 5) continue;
            const [name, phone, group, date, status] = cols.map(item => item.trim());
            if (name && phone && group && date && status) {
              newStudents.push({ name, phone, group, date, status });
            }
          }

          if (newStudents.length > 0) {
            // Clear existing data first
            students = [];
            saveStudentsToLocal();

            // Add each student to Supabase
            newStudents.forEach(student => {
              addStudent(student);
            });
            showToast('CSV imported successfully', 'success');
          } else {
            showToast('No valid student records found in CSV', 'error');
          }
        } catch (err) {
          showToast('Error parsing CSV', 'error');
        }
        hideLoading();
      }, 500);
    };
    reader.readAsText(file);
  });

  // Dark mode toggle
  darkModeToggle.addEventListener("click", () => {
    const isDark = document.documentElement.classList.toggle("dark");
    localStorage.setItem("darkMode", isDark);

    if (isDark) {
      toggleThumb.classList.add("translate-x-8");
      toggleThumb.classList.remove("translate-x-0");
      toggleIcon.textContent = 'â˜€ï¸';
    } else {
      toggleThumb.classList.add("translate-x-0");
      toggleThumb.classList.remove("translate-x-8");
      toggleIcon.textContent = 'ðŸŒ™';
    }

    if (typeof updateCharts === 'function') updateCharts();
  });

  // Initialize dark mode if previously set
  if (localStorage.getItem("darkMode") === "true") {
    document.documentElement.classList.add("dark");
    toggleThumb.classList.add("translate-x-8");
    toggleIcon.textContent = 'â˜€ï¸';
  } else {
    toggleThumb.classList.add("translate-x-0");
    toggleIcon.textContent = 'ðŸŒ™';
  }

  // Update charts
  const updateCharts = () => {
    const statusCounts = { "not_Checked": 0, "None": 0, "Called": 0, "Follow-Up Needed": 0, "Agreed": 0, "Confirmed": 0, "Paid": 0 };
    const groupCounts = {};
    const deptCounts = { "Science": 0, "Commerce": 0, "Arts": 0 };

    students.forEach(student => {
      if (statusCounts.hasOwnProperty(student.status)) {
        statusCounts[student.status]++;
      }
      groupCounts[student.group] = (groupCounts[student.group] || 0) + 1;
      const groupLower = student.group.trim().toLowerCase();
      if (groupLower === "science") deptCounts["Science"]++;
      else if (groupLower === "commerce") deptCounts["Commerce"]++;
      else if (groupLower === "arts") deptCounts["Arts"]++;
    });

    // Define color mapping for all statuses
    const statusColors = {
      'not_Checked': { bg: '#9CA3AF', border: '#6B7280' },
      'None': { bg: '#36454F', border: '#B91C1C' },
      'Called': { bg: '#DBEAFE', border: '#1E40AF' },
      'Follow-Up Needed': { bg: '#FEE2E2', border: '#92400E' },
      'Agreed': { bg: '#7ff09b', border: '#065F46' },
      'Confirmed': { bg: '#FEF9C3', border: '#5B21B6' },
      'Paid': { bg: '#06c635', border: '#047857' }
    };

    // Destroy existing charts if they exist
    if (statusChart) statusChart.destroy();
    if (groupChart) groupChart.destroy();
    if (deptChart) deptChart.destroy();

    // Pie Chart: Status Distribution
    statusChart = new Chart(ctxStatus, {
      type: 'pie',
      data: {
        labels: Object.keys(statusCounts),
        datasets: [{
          label: 'Status Distribution',
          data: Object.values(statusCounts),
          backgroundColor: Object.keys(statusCounts).map(status => statusColors[status].bg),
          borderColor: Object.keys(statusCounts).map(status => statusColors[status].border),
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'bottom',
            labels: {
              color: document.documentElement.classList.contains('dark') ? '#E5E7EB' : '#374151',
              usePointStyle: true,
              pointStyle: 'circle',
              padding: 20
            }
          },
          tooltip: {
            backgroundColor: document.documentElement.classList.contains('dark') ? '#1F2937' : '#FFFFFF',
            titleColor: document.documentElement.classList.contains('dark') ? '#F9FAFB' : '#111827',
            bodyColor: document.documentElement.classList.contains('dark') ? '#E5E7EB' : '#374151',
            borderColor: document.documentElement.classList.contains('dark') ? '#4B5563' : '#D1D5DB',
            borderWidth: 1
          }
        }
      }
    });

    // Bar Chart: Group Distribution
    const getGroupColors = (count) => {
      const lightModeColors = [
        'rgba(96, 165, 250, 0.9)',
        'rgba(52, 211, 153, 0.9)',
        'rgba(251, 191, 36, 0.9)',
        'rgba(129, 140, 248, 0.9)',
        'rgba(248, 113, 113, 0.9)',
      ];
      const darkModeColors = [
        'rgba(96, 165, 250, 0.9)',
        'rgba(52, 211, 153, 0.9)',
        'rgba(251, 191, 36, 0.9)',
        'rgba(129, 140, 248, 0.9)',
        'rgba(248, 113, 113, 0.9)',
      ];
      return document.documentElement.classList.contains('dark')
        ? darkModeColors.slice(0, count)
        : lightModeColors.slice(0, count);
    };

    groupChart = new Chart(ctxGroup, {
      type: 'bar',
      data: {
        labels: Object.keys(groupCounts),
        datasets: [{
          label: 'Group Distribution',
          data: Object.values(groupCounts),
          backgroundColor: getGroupColors(Object.keys(groupCounts).length),
          borderColor: document.documentElement.classList.contains('dark')
            ? 'rgba(255, 255, 255, 0.2)'
            : 'rgba(0, 0, 0, 0.1)',
          borderWidth: 1,
          borderRadius: {
            topLeft: 6,
            topRight: 6,
            bottomLeft: 0,
            bottomRight: 0
          },
          barThickness: 40,
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'bottom',
            labels: {
              color: document.documentElement.classList.contains('dark')
                ? '#E2E8F0'
                : '#1E293B',
              font: {
                size: 12,
                weight: '500'
              },
              padding: 20,
              usePointStyle: true,
              pointStyle: 'circle'
            }
          },
          tooltip: {
            backgroundColor: document.documentElement.classList.contains('dark')
              ? '#1E293B'
              : '#FFFFFF',
            titleColor: document.documentElement.classList.contains('dark')
              ? '#F8FAFC'
              : '#1E293B',
            bodyColor: document.documentElement.classList.contains('dark')
              ? '#E2E8F0'
              : '#475569',
            borderColor: '#64748B',
            borderWidth: 1,
            cornerRadius: 6,
            padding: 12,
            displayColors: true,
            callbacks: {
              label: function (context) {
                return `${context.parsed.y} students`;
              }
            }
          }
        },
        scales: {
          x: {
            grid: {
              display: false,
              drawBorder: false
            },
            ticks: {
              color: document.documentElement.classList.contains('dark')
                ? '#94A3B8'
                : '#475569',
              font: {
                size: 12,
                weight: '500'
              }
            }
          },
          y: {
            grid: {
              color: document.documentElement.classList.contains('dark')
                ? 'rgba(255, 255, 255, 0.1)'
                : 'rgba(0, 0, 0, 0.05)',
              drawBorder: false,
              borderDash: [4, 4]
            },
            ticks: {
              color: document.documentElement.classList.contains('dark')
                ? '#94A3B8'
                : '#475569',
              font: {
                size: 12,
                weight: '500'
              },
              callback: function (value) {
                return Number.isInteger(value) ? value : '';
              }
            },
            beginAtZero: true
          }
        },
        animation: {
          duration: 1000,
          easing: 'easeOutQuart'
        }
      }
    });

    // Bar Chart: Department Distribution
    deptChart = new Chart(ctxDept, {
      type: 'bar',
      data: {
        labels: Object.keys(deptCounts),
        datasets: [{
          label: 'Department Distribution',
          data: Object.values(deptCounts),
          backgroundColor: [
            'rgba(96, 165, 250, 0.9)',
            'rgba(52, 211, 153, 0.9)',
            'rgba(129, 140, 248, 0.9)'
          ],
          borderColor: document.documentElement.classList.contains('dark')
            ? 'rgba(255, 255, 255, 0.2)'
            : 'rgba(0, 0, 0, 0.1)',
          borderWidth: 1,
          borderRadius: {
            topLeft: 6,
            topRight: 6,
            bottomLeft: 0,
            bottomRight: 0
          },
          barThickness: 40,
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'bottom',
            labels: {
              color: document.documentElement.classList.contains('dark')
                ? '#E2E8F0'
                : '#1E293B',
              font: {
                size: 12,
                weight: '500'
              },
              padding: 20,
              usePointStyle: true,
              pointStyle: 'circle'
            }
          },
          tooltip: {
            backgroundColor: document.documentElement.classList.contains('dark')
              ? '#1E293B'
              : '#FFFFFF',
            titleColor: document.documentElement.classList.contains('dark')
              ? '#F8FAFC'
              : '#1E293B',
            bodyColor: document.documentElement.classList.contains('dark')
              ? '#E2E8F0'
              : '#475569',
            borderColor: '#64748B',
            borderWidth: 1,
            cornerRadius: 6,
            padding: 12,
            displayColors: true,
            callbacks: {
              label: function (context) {
                return `${context.parsed.y} students`;
              }
            }
          }
        },
        scales: {
          x: {
            grid: {
              display: false,
              drawBorder: false
            },
            ticks: {
              color: document.documentElement.classList.contains('dark')
                ? '#94A3B8'
                : '#475569',
              font: {
                size: 12,
                weight: '500'
              }
            }
          },
          y: {
            grid: {
              color: document.documentElement.classList.contains('dark')
                ? 'rgba(255, 255, 255, 0.1)'
                : 'rgba(0, 0, 0, 0.05)',
              drawBorder: false,
              borderDash: [4, 4]
            },
            ticks: {
              color: document.documentElement.classList.contains('dark')
                ? '#94A3B8'
                : '#475569',
              font: {
                size: 12,
                weight: '500'
              },
              callback: function (value) {
                return Number.isInteger(value) ? value : '';
              }
            },
            beginAtZero: true
          }
        },
        animation: {
          duration: 1000,
          easing: 'easeOutQuart'
        }
      }
    });
  };

  // Initial fetch of students
  fetchStudents();
});
</script>

</body>
</html>